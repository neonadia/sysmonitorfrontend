{% extends "chart_base.html" %}

{% block canvas %}
        <canvas id="canvas_vrmtemperatures"></canvas>
{% endblock%}

{% block config %}
        var config_temperatures = {
            type: 'line',
            data: {
                labels: dataset.datetime,
                datasets: []
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: dataset.RACK + ' | ' + dataset.bmc_ip + ' | Voltage Regulator Module Temperatures',
                    fontSize: 30
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Datetime'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Celsius'
                        }
                    }]
                },
                plugins: {
                    zoom: {
                        // Container for pan options
                        pan: {
                            // Boolean to enable panning
                            enabled: true,

                            // Panning directions. Remove the appropriate direction to disable
                            // Eg. 'y' would only allow panning in the y direction
                            mode: 'xy'
                        },

                        // Container for zoom options
                        zoom: {
                            // Boolean to enable zooming
                            enabled: true,

                            // Zooming directions. Remove the appropriate direction to disable
                            // Eg. 'y' would only allow zooming in the y direction
                            mode: 'x',
                        }
                    }
                }
            }
        };

        var i;

        for (i = 0; i < dataset.Temperatures.length; i++){ 
            if (dataset['Temperatures'][i]['Name'].includes('VRM')) {
                colorNames = Object.keys(window.chartColors);
                colorName = colorNames[config_temperatures.data.datasets.length % colorNames.length];
                newColor = window.chartColors[colorName];
                newDataset = {
                        label: dataset['Temperatures'][i]['Name'],
                        backgroundColor: newColor,
                        borderColor: newColor,
                        data: dataset['Temperatures'][i]['Reading'],
                        fill: false
                };
                config_temperatures.data.datasets.push(newDataset);
            }
        }

        window.onload = function() {
            var ctx_temperatures = document.getElementById('canvas_vrmtemperatures').getContext('2d');
            window.myLine = new Chart(ctx_temperatures, config_temperatures);
        };
{% endblock %}

{% block submit %}
        document.getElementById('submit').addEventListener('click', function() {
            start = document.getElementById("start").value;
            end = document.getElementById("end").value;

            const regex = /[12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]) ([01][0-9]|2[0-3]):[0-5]\d:[0-5]\d$/;
            
            if (regex.test(start) == false || regex.test(end) == false || start.localeCompare(end) == 1) {
                document.getElementById('defaulttime').click();
            }

            var range = getRange(dataset.datetime, start, end);
            var n_labels = [];
            var i;

            // trimm those points which are unneccesarry
            var step = 1; 
            if ( (range[1] - range[0]) > 100 ){ // only show 100 points
                step = Math.round((range[1] - range[0])/100)
            }
            //

            for (i=range[0]; i <= range[1]; i=i+step) {
                n_labels.push(dataset.datetime[i]);
            }
            config_temperatures.data.labels = n_labels;

            var n_data = [];
            var counter = 0;
            for (j=0; j <= dataset['Temperatures'].length-1; j++) {
                n_data = [];
                if (dataset['Temperatures'][j]['Name'].includes('VRM')) { // VRM only
                    for (i=range[0]; i <= range[1]; i=i+step) {
                        n_data.push(dataset['Temperatures'][j]['Reading'][i]);
                    }
                config_temperatures.data.datasets[counter].data = n_data;
                counter += 1;
                }
            }
            window.myLine.resetZoom();
            window.myLine.update();
        });
{% endblock %}